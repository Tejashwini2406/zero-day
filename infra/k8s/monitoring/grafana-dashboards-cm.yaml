apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
data:
  anomaly-detection-dashboard.json: |
    {
      "dashboard": {
        "title": "Zero-Day Detection Dashboard",
        "panels": [
          {
            "title": "Anomaly Scores Over Time",
            "targets": [
              {
                "expr": "anomaly_score{job='inference'}"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Model Inference Latency",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, inference_latency_ms)"
              }
            ],
            "type": "stat"
          },
          {
            "title": "Alert Counts by Pod",
            "targets": [
              {
                "expr": "count(containment_alerts) by (pod_name)"
              }
            ],
            "type": "bargauge"
          },
          {
            "title": "Containment Actions Applied",
            "targets": [
              {
                "expr": "sum(rate(containment_actions_total[5m])) by (action)"
              }
            ],
            "type": "graph"
          },
          {
            "title": "False Positive Rate",
            "targets": [
              {
                "expr": "false_positive_rate{job='validation'}"
              }
            ],
            "type": "gauge"
          }
        ]
      }
    }

  prometheus-rules.yaml: |
    groups:
    - name: zero-day-detection
      rules:
      - alert: HighAnomalyScore
        expr: anomaly_score{job="inference"} > 0.9
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "High anomaly score for {{ $labels.pod }}"
          description: "Pod {{ $labels.pod }} in {{ $labels.namespace }} has anomaly score {{ $value }}"

      - alert: ModelInferenceLagHigh
        expr: inference_latency_ms > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Inference latency degradation"
          description: "Inference service latency (p95) is {{ $value }}ms"

      - alert: ContainmentFailure
        expr: increase(containment_actions_failed_total[5m]) > 0
        labels:
          severity: high
        annotations:
          summary: "Containment action failed"
          description: "{{ $value }} containment actions failed in past 5m"

      - alert: HighFalsePositiveRate
        expr: false_positive_rate > 0.1
        for: 10m
        labels:
          severity: medium
        annotations:
          summary: "Abnormally high false positive rate"
          description: "FP rate is {{ $value | humanizePercentage }}, check model calibration"
