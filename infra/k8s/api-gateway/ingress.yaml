---
# API Gateway for Zero-Day SaaS
# Using Nginx Ingress Controller with authentication and rate limiting
---
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
---
# Nginx Ingress ConfigMap with rate limiting and auth
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-configuration
  namespace: ingress-nginx
data:
  # Global rate limit
  limit-rps: "1000"
  limit-connections: "10"
  
  # Security headers
  add-headers: "true"
  server-tokens: "false"
  
  # TLS
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"
  
  # Logging
  log-format-upstream: "$remote_addr - $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\" $request_time $upstream_addr $upstream_status"
  
  # Proxy settings
  proxy-read-timeout: "600"
  proxy-connect-timeout: "600"
---
# API Gateway Service
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: ingress-nginx
spec:
  type: LoadBalancer
  ports:
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP
  - name: https
    port: 443
    targetPort: 443
    protocol: TCP
  selector:
    app: nginx-ingress
---
# API Gateway IngressClass
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx-api-gateway
spec:
  controller: k8s.io/ingress-nginx
---
# Main API Ingress with authentication
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zero-day-api-ingress
  namespace: ml
  annotations:
    kubernetes.io/ingress.class: nginx-api-gateway
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/auth-type: jwt
    nginx.ingress.kubernetes.io/auth-jwt-secret: ml/jwt-secret
    nginx.ingress.kubernetes.io/auth-jwt-verify: "on"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
spec:
  ingressClassName: nginx-api-gateway
  tls:
  - hosts:
    - api.zero-day.io
    secretName: api-tls-cert
  rules:
  - host: api.zero-day.io
    http:
      paths:
      - path: /v1/inference
        pathType: Prefix
        backend:
          service:
            name: inference-service
            port:
              number: 8080
      - path: /v1/graphs
        pathType: Prefix
        backend:
          service:
            name: graph-service
            port:
              number: 8081
      - path: /v1/alerts
        pathType: Prefix
        backend:
          service:
            name: alert-service
            port:
              number: 8082
      - path: /v1/metrics
        pathType: Prefix
        backend:
          service:
            name: metrics-service
            port:
              number: 8083
---
# JWT Secret for API authentication
apiVersion: v1
kind: Secret
metadata:
  name: jwt-secret
  namespace: ml
type: Opaque
data:
  # Base64 encoded JWT signing key (generate with: openssl rand -base64 32)
  key: SXNzdWVkQXRFbmRUaW1lIEp3dFNlY3JldENoYW5nZU1lSW5Qcm9kdWN0aW9u
---
# Service for inference API
apiVersion: v1
kind: Service
metadata:
  name: inference-service
  namespace: ml
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  selector:
    app: inference-service
---
# Service for graph API
apiVersion: v1
kind: Service
metadata:
  name: graph-service
  namespace: ml
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8081
    targetPort: 8080
  selector:
    app: graph-api
---
# Service for alert API
apiVersion: v1
kind: Service
metadata:
  name: alert-service
  namespace: ml
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8082
    targetPort: 8080
  selector:
    app: alert-service
---
# Service for metrics API
apiVersion: v1
kind: Service
metadata:
  name: metrics-service
  namespace: ml
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8083
    targetPort: 8080
  selector:
    app: metrics-service
---
# Rate limit policy
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-rate-limits
  namespace: ingress-nginx
data:
  limits.conf: |
    # Rate limits per tier
    FREE_TIER_RPS: 10
    STARTER_TIER_RPS: 100
    PROFESSIONAL_TIER_RPS: 500
    ENTERPRISE_TIER_RPS: 2000
    
    # Concurrent request limits
    FREE_TIER_CONCURRENT: 5
    STARTER_TIER_CONCURRENT: 20
    PROFESSIONAL_TIER_CONCURRENT: 100
    ENTERPRISE_TIER_CONCURRENT: 500
---
# Certificate for API endpoint
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-tls-cert
  namespace: ml
spec:
  secretName: api-tls-cert
  duration: 2160h  # 90 days
  renewBefore: 720h  # 30 days
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - api.zero-day.io
  - "*.zero-day.io"
---
# ClusterIssuer for Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@zero-day.io
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx-api-gateway
